<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Grupos - Igreja Batista de Cedofeita</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a6e2a 100%);
        }

        /* Login Screen */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #2d5016 0%, #4a6e2a 100%);
        }

        #login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        #login-box h1 {
            color: #2d5016;
            margin-bottom: 10px;
            font-size: 28px;
        }

        #login-box h2 {
            color: #d4c5a0;
            margin-bottom: 30px;
            font-size: 18px;
            font-weight: normal;
        }

        #password-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #d4c5a0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #password-input:focus {
            outline: none;
            border-color: #2d5016;
        }

        #login-btn {
            width: 100%;
            padding: 15px;
            background: #2d5016;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        #login-btn:hover {
            background: #3d6a20;
        }

        .error-message {
            color: #d32f2f;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        /* Map Container */
        #map-container {
            display: none;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Header */
        #header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        #header h1 {
            color: #2d5016;
            font-size: 20px;
            margin: 0;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .legend h3 {
            color: #2d5016;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-icon {
            width: 25px;
            height: 25px;
            margin-right: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .legend-icon.holst {
            background: #2d5016;
        }

        .legend-icon.membro {
            background: #d4c5a0;
            color: #2d5016;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            top: 80px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .control-panel button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #2d5016;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .control-panel button:hover {
            background: #3d6a20;
        }

        .control-panel button.active {
            background: #4a6e2a;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2d5016;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
        }

        .popup-title {
            color: #2d5016;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid #d4c5a0;
            padding-bottom: 5px;
        }

        .popup-type {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .popup-type.holst {
            background: #2d5016;
            color: white;
        }

        .popup-type.membro {
            background: #d4c5a0;
            color: #2d5016;
        }

        .popup-info {
            color: #333;
            line-height: 1.6;
        }

        .popup-address {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #header h1 {
                font-size: 16px;
            }
            
            .legend {
                bottom: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .control-panel {
                top: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container">
        <div id="login-box">
            <h1>üèõÔ∏è Igreja Batista de Cedofeita</h1>
            <h2>Mapa de Grupos Familiares</h2>
            <input type="password" id="password-input" placeholder="Digite a senha" />
            <button id="login-btn">Entrar</button>
            <p class="error-message" id="error-message">Senha incorreta. Tente novamente.</p>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map-container">
        <div id="header">
            <h1>üèõÔ∏è Mapa de Grupos Familiares - Igreja Batista de Cedofeita</h1>
        </div>

        <div class="control-panel">
            <button id="toggle-heatmap">üî• Mostrar Mapa de Calor</button>
            <button id="show-all">üë• Mostrar Todos</button>
            <button id="show-holst">üè† Apenas Holst</button>
            <button id="show-members">üë§ Apenas Membros</button>
        </div>

        <div id="map"></div>

        <div class="legend">
            <h3>Legenda</h3>
            <div class="legend-item">
                <div class="legend-icon holst">H</div>
                <span>Holst (Anfitri√£o)</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon membro">M</div>
                <span>Membro</span>
            </div>
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Carregando dados...</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        // Configuration
        const SHEET_ID = '1hoB1CvxYDuIeeEsW2v37Ny2QT9ygRIKJGzLa_q6dtok';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        
        let map;
        let markers = [];
        let heatLayer;
        let markerClusterGroup;
        let allData = [];
        let correctPassword = 'IEBCedofeita'; // Default password
        let heatmapVisible = false;

        // Login functionality
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        function login() {
            const inputPassword = document.getElementById('password-input').value;
            if (inputPassword === correctPassword) {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('map-container').style.display = 'block';
                initializeMap();
            } else {
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('password-input').value = '';
            }
        }

        // Initialize map
        function initializeMap() {
            document.getElementById('loading').style.display = 'block';
            
            // Create map centered on Porto
            map = L.map('map').setView([41.1579, -8.6291], 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });

            // Load data from Google Sheets
            loadDataFromSheet();

            // Control panel buttons
            document.getElementById('toggle-heatmap').addEventListener('click', toggleHeatmap);
            document.getElementById('show-all').addEventListener('click', () => filterMarkers('all'));
            document.getElementById('show-holst').addEventListener('click', () => filterMarkers('holst'));
            document.getElementById('show-members').addEventListener('click', () => filterMarkers('membro'));
        }

        // Load data from Google Sheets
        async function loadDataFromSheet() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                
                // Parse Google Sheets JSON response
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;

                // Extract password from first row, column I (index 8)
                if (rows.length > 0 && rows[0].c[8] && rows[0].c[8].v) {
                    correctPassword = rows[0].c[8].v;
                }

                // Process data (skip header row)
                allData = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row.c || !row.c[0] || !row.c[1]) continue;
                    
                    const nome = row.c[0]?.v || '';
                    const endereco = row.c[1]?.v || '';
                    const info = row.c[2]?.v || '';
                    const tipo = row.c[3]?.v || 'Membro';
                    
                    if (nome && endereco) {
                        allData.push({ nome, endereco, info, tipo });
                    }
                }

                // Geocode all addresses
                await geocodeAllAddresses();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Erro ao carregar dados. Por favor, tente novamente.');
            }
        }

        // Geocode all addresses
        async function geocodeAllAddresses() {
            const geocodedData = [];
            
            for (const item of allData) {
                const coords = await geocodeAddress(item.endereco);
                if (coords) {
                    geocodedData.push({ ...item, lat: coords[0], lng: coords[1] });
                }
                // Add delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            allData = geocodedData;
            displayMarkers(allData);
            document.getElementById('loading').style.display = 'none';
        }

        // Geocode single address using Nominatim
        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=pt&limit=1`
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Display markers on map
        function displayMarkers(data) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            markerClusterGroup.clearLayers();

            // Create markers
            data.forEach(item => {
                const isHolst = item.tipo.toLowerCase().includes('holst');
                
                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${isHolst ? '#2d5016' : '#d4c5a0'};
                        color: ${isHolst ? 'white' : '#2d5016'};
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 18px;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        cursor: pointer;
                    ">${isHolst ? 'H' : 'M'}</div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });

                // Create marker
                const marker = L.marker([item.lat, item.lng], { icon: icon });
                
                // Add tooltip (on hover)
                marker.bindTooltip(item.nome, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10]
                });

                // Add popup (on click)
                const popupContent = `
                    <div class="popup-title">${item.nome}</div>
                    <div class="popup-type ${isHolst ? 'holst' : 'membro'}">
                        ${isHolst ? 'üè† Holst (Anfitri√£o)' : 'üë§ Membro'}
                    </div>
                    <div class="popup-info">
                        ${item.info ? `<p>${item.info}</p>` : ''}
                    </div>
                    <div class="popup-address">
                        üìç ${item.endereco}
                    </div>
                `;
                marker.bindPopup(popupContent);

                marker.itemData = item; // Store data for filtering
                markers.push(marker);
                markerClusterGroup.addLayer(marker);
            });

            map.addLayer(markerClusterGroup);

            // Fit map to markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }

            // Create heatmap data
            createHeatmap(data);
        }

        // Create heatmap
        function createHeatmap(data) {
            const heatData = data.map(item => [item.lat, item.lng, 1]);
            
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
            
            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 35,
                maxZoom: 17,
                gradient: {
                    0.0: '#d4c5a0',
                    0.5: '#4a6e2a',
                    1.0: '#2d5016'
                }
            });
        }

        // Toggle heatmap
        function toggleHeatmap() {
            heatmapVisible = !heatmapVisible;
            const button = document.getElementById('toggle-heatmap');
            
            if (heatmapVisible) {
                map.addLayer(heatLayer);
                button.classList.add('active');
                button.textContent = 'üî• Ocultar Mapa de Calor';
            } else {
                map.removeLayer(heatLayer);
                button.classList.remove('active');
                button.textContent = 'üî• Mostrar Mapa de Calor';
            }
        }

        // Filter markers
        function filterMarkers(filter) {
            markerClusterGroup.clearLayers();
            
            markers.forEach(marker => {
                const item = marker.itemData;
                const isHolst = item.tipo.toLowerCase().includes('holst');
                
                if (filter === 'all') {
                    markerClusterGroup.addLayer(marker);
                } else if (filter === 'holst' && isHolst) {
                    markerClusterGroup.addLayer(marker);
                } else if (filter === 'membro' && !isHolst) {
                    markerClusterGroup.addLayer(marker);
                }
            });

            // Update button states
            document.querySelectorAll('.control-panel button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (filter === 'all') {
                document.getElementById('show-all').classList.add('active');
            } else if (filter === 'holst') {
                document.getElementById('show-holst').classList.add('active');
            } else if (filter === 'membro') {
                document.getElementById('show-members').classList.add('active');
            }
        }
    </script>
</body>
</html>